name: Generate A4 Syllabus Book (PDF)

on:
  workflow_dispatch:

permissions:
  contents: write   # required to commit generated PDF

jobs:
  build-a4:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # 1. Checkout repository (shallow clone)
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2. Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Install ONLY required Python dependency
      - name: Install Python dependency
        run: |
          pip install --no-cache-dir TexSoup

      # 4. Generate LaTeX (validation + content)
      # Must produce: outputs/a4/master_syllabus.tex
      - name: Generate A4 LaTeX
        run: |
          python scripts/process_courses.py --format a4

     # 5. Compile A4 PDF (Explicitly set the output directory)
      - name: Compile A4 PDF
        uses: xu-cheng/latex-action@v3
        with:
          root_file: masters/syllabus_a4.tex
          compiler: xelatex
          args: "-interaction=nonstopmode -halt-on-error -output-directory=outputs/a4"

      # 6. Commit generated files (Added a list command for debugging)
      - name: Commit generated A4 PDF
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # This command helps us see exactly where the files are in the logs
          ls -R outputs/
          
          git add outputs/a4/*.pdf
          git add outputs/a4/*.tex
          
          git diff --cached --quiet || git commit -m "Auto-generate A4 syllabus book"
          git push
        
